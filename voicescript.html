<html>
<head>
<meta charset="UTF-8">
<title>Voice Script</title>
<link rel="stylesheet" href="voicescript.css">


<script src="http://code.jquery.com/jquery-2.0.3.min.js"></script>
<script src="//code.jquery.com/ui/1.11.4/jquery-ui.js"></script>

<!-- Latest compiled and minified CSS -->
<link rel="stylesheet"
	href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css"
	integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7"
	crossorigin="anonymous">

<!-- Optional theme -->
<link rel="stylesheet"
	href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css"
	integrity="sha384-fLW2N01lMqjakBkx3l/M9EahuwpSfeNvV63J5ezn3uZzapT0u7EYsXMjQV+0En5r"
	crossorigin="anonymous">

<!-- Latest compiled and minified JavaScript -->
<script
	src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"
	integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS"
	crossorigin="anonymous"></script>


<script src="nwunsch.js" type="text/javascript"></script>
<script src="segment.js" type="text/javascript"></script>
<script src="script.js" type="text/javascript"></script>
<script src="visualizetext.js" type="text/javascript"></script>
<script src="merge.js" type="text/javascript"></script>
<script src="editscript.js" type="text/javascript"></script>
<script src="//www.WebRTC-Experiment.com/RecordRTC.js"></script>
</head>

<script>
	var masterscript = null;
	var transcript = null;
	var segmenter = null;
	var match = null;
	var sortable = false;

	function loadTranscript() {
		var filename = document.getElementById("transcript_file").value;
		var request = new XMLHttpRequest();
		request.open("GET", filename, false);
		request.send(null);
		transcript = new Script();
		transcript.initFromAudio(request.responseText, null);
		reinit();
	};

	function loadMasterscript() {
		var filename = document.getElementById("masterscript_file").value;
		var request = new XMLHttpRequest();
		request.open("GET", filename, false);
		request.send(null);
		masterscript = new Script();
		masterscript.initFromText(request.responseText);
		reinit();
	};

	function reinit() {
		segmenter = null;
		match = null;
	};

	function showScriptTable() {
		$('#script-table tbody').empty();
		var trow = $("<tr/>");
		$('#script-table tbody:last').append(trow);
		var td = $("<td/>");
		td.addClass('col-md-6');
		td.attr('id', 'masterscript');
		trow.append(td);
		td = $("<td/>");
		td.attr('id', 'transcript');
		td.addClass('col-md-6');
		trow.append(td);

		if (sortable) {
			$('#script-table tbody').sortable('disable');
			$('#script-table tbody').enableSelection();
		}

		$('#btn-align').show();
		$('#btn-merge').hide();
	};

	function showMasterscript() {
		var msspan = masterscript.getSpans();
		$('#masterscript').empty().append(msspan);
		$('#masterscript').attr('contentEditable', true);
		document.getElementById("masterscript").addEventListener("keydown",
				saveEditNodes, false);
		document.getElementById("masterscript").addEventListener("keyup",
				editMasterscript, false);
		document.getElementById("masterscript").addEventListener("contextmenu",
				contextMasterscript, false);
	};

	function showTranscript() {
		loadTranscript();
		var tspan = transcript.getSpans();
		$('#transcript').empty().append(tspan);
	};

	function alignWords() {
		// Get from current script
		// Compute alignment of two texts
		masterscript = new Script();
		masterscript.initFromSpans($('#masterscript').children('span'));
		transcript = new Script();
		transcript.initFromSpans($('#transcript').children('span'));
		var pmatch = 1;
		var pmis = -2;
		var pgap = -1;
		var aligner = new NeedlemanWunsch(masterscript, transcript, pmatch,
				pmis, pgap);
		match = aligner.align();
	};

	function alignSegments() {
		// Compute word-to-word match
		alignWords();
		segmenter = new Segmenter(masterscript, transcript, match);
		segmenter.iterateSegment(2);
		var ms_segments = segmenter.getSrc1Segments();
		var t_segments = segmenter.getSrc2Segments();
		TextSegment.matchSegments(ms_segments, t_segments, match);
		printAlignedTextSegments('#script-table', ms_segments, t_segments,
				match);

		$('#btn-align').toggle();
		$('#btn-merge').toggle();
		$('#script-table tbody').sortable('enable');
		$('#script-table tbody').enableSelection();

		sortable = true;
	};

	function mergeSegments() {
		var cell_ids = getCheckedSegs('#script-table');
		masterscript = mergeSegs2Script(cell_ids);
		showScripts();
	};

	function showScripts() {
		showScriptTable();
		showMasterscript();
		showTranscript();
	};

	$(window).load(function() {
		loadTranscript();
		loadMasterscript();
		showScripts();

		$('body').click(function() {
			$('#contextEditMenu').hide();
		});

		$('[data-toggle="tooltip"]').tooltip();
	});
</script>
<body>
	<div class="container">
		<div class="col-md-6">
			<h1>
				Master Script&nbsp;&nbsp; <select id="masterscript_file"
					onchange="showScripts()">
					<option value="script1.json">script1.json</option>
				</select>
			</h1>
		</div>
		<div class="col-md-6">
			<h1>
				Audio Transcript &nbsp;&nbsp; <select id="transcript_file"
					onchange="showTranscript()">
					<option value="audio1.json">audio1.json</option>
					<option value="audio2.json">audio2.json</option>
					<option value="audio3.json">audio3.json</option>
					<option value="audio4.json">audio4.json</option>
				</select>
			</h1>
		</div>
		<table class="table" id="script-table">
			<tbody>
				<tr>
					<td class="col-md-6" id="masterscript"></td>
					<td class="col-md-6" id="transcript"></td>
				</tr>
			</tbody>
		</table>
		<div class="text-center">
			<button class="btn btn-primary" onclick="alignSegments()"
				id="btn-align">Align</button>
			<button class="btn btn-success" onclick="mergeSegments()"
				id="btn-merge">Merge</button>
			<br> <br>
		</div>

		<!-- Comments -->
		<div class="row">
			<div class="col-sm-3">
				<div class="thumbnail">
					<div class="caption">
						<p>This is a sample comment</p>
						<p>
							<a href="#" class="btn btn-default" role="button"
								data-toggle="tooltip" data-placement="top" title="Resolved"><i
								class="glyphicon glyphicon-ok"></i></a> <a href="#"
								class="btn btn-info" role="button" data-toggle="tooltip"
								data-placement="top" title="Edit"><i
								class="glyphicon glyphicon-pencil"></i></a> <a href="#"
								class="btn btn-danger" role="button" data-toggle="tooltip"
								data-placement="top" title="Delete"><i
								class="glyphicon glyphicon-remove"></i></a>
						</p>
					</div>
				</div>
			</div>
		</div>
		<br> <br>

	</div>



	<ul id="contextEditMenu" class="dropdown-menu" role="menu"
		style="display: none">
		<li><a tabindex="-1" href="#" onclick="markSelectedDirty()"><i
				class="glyphicon glyphicon-exclamation-sign"></i>&nbsp;Mark as dirty</a></li>
		<li><a tabindex="-1" href="#" onclick="markSelectedClean()"><i
				class="glyphicon glyphicon-ok-sign"></i>&nbsp;Mark as good</a></li>
		<li><a tabindex="-1" href="#"><i
				class="glyphicon glyphicon-comment"></i>&nbsp;View / Add Comments</a></li>
	</ul>
</body>
</html>