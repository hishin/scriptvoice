<html>
<head>
<meta charset="UTF-8">
<title>Voice Script</title>
<link rel="stylesheet"
	href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
<link rel="stylesheet" href="voicescript.css">
<script
	src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
<script src="//code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
<script src="ibmspeech.js" type="text/javascript"></script>
<script src="nwunsch.js" type="text/javascript"></script>
<script src="segment.js" type="text/javascript"></script>
<script src="script.js" type="text/javascript"></script>
<script src="visualizetext.js" type="text/javascript"></script>

</head>

<script>
	var masterscript = null;
	var transcript = null;
	var segmenter = null;
	var match = null;
	var ms_segments = null;
	var t_segments = null;

	function loadTranscript() {
		var filename = document.getElementById("transcript_file").value;
		var request = new XMLHttpRequest();
		request.open("GET", filename, false);
		request.send(null);
		transcript = new Script();
		transcript.initFromAudio(request.responseText, null);
		reinit();
	};

	function loadMasterscript() {
		var filename = document.getElementById("masterscript_file").value;
		var request = new XMLHttpRequest();
		request.open("GET", filename, false);
		request.send(null);
		masterscript = new Script();
		masterscript.initFromText(request.responseText);
		reinit();

	};

	function reinit() {
		segmenter = null;
		match = null;
		ms_segments = null;
		t_segments = null;
	};

	function align() {
		// Compute alignment of two texts
		var pmatch = 1;
		var pmis = -2;
		var pgap = -1;

		var aligner = new NeedlemanWunsch(masterscript, transcript, pmatch,
				pmis, pgap);
		match = aligner.align();
	};

	function showMatch() {
		// Visualize correspondence per word.
		var msspan = visualizeMatch(Script.tokens2spans(masterscript
				.getTokens()), match.match1to2);
		var tspan = visualizeMatch(Script.tokens2spans(transcript.getTokens()),
				match.match2to1);

		$('#masterscript').empty().append(msspan);
		$('#transcript').empty().append(tspan);
	};

	function realign() {
		loadTranscript();
		loadMasterscript();
		align();
		showMatch();
	};

	function merge() {
		segmenter = new Segmenter(masterscript, transcript, match);
		segmenter.iterateSegment(2);
		ms_segments = segmenter.getSrc1Segments();
		t_segments = segmenter.getSrc2Segments();
		TextSegment.matchSegments(ms_segments, t_segments, match);
		printAlignedTextSegments('#merge-script-table', ms_segments,
				t_segments, match);

	};

	$(window).load(function() {
		// Load sample transcript
		loadTranscript();
		loadMasterscript();
		align();
		showMatch();
		$('#merge-script-table tbody').sortable().disableSelection();
	});
</script>
<body>
	<div class="container">
		<div class="col-md-6">
			<h1>
				Master Script&nbsp;&nbsp; <select id="masterscript_file"
					onchange="realign()">
					<option value="script1.json">script1.json</option>
				</select>
			</h1>
		</div>
		<div class="col-md-6">
			<h1>
				Audio Transcript &nbsp;&nbsp; <select id="transcript_file"
					onchange="realign()">
					<option value="audio1.json">audio1.json</option>
					<option value="audio2.json">audio2.json</option>
					<option value="audio3.json">audio3.json</option>
					<option value="audio4.json">audio4.json</option>
				</select>
			</h1>
		</div>
		<table class="table" id="script-table">
			<tbody>
				<tr>
					<td class="col-md-6" id="masterscript"></td>
					<td class="col-md-6" id="transcript"></td>
				</tr>
			</tbody>
		</table>
		<div class="text-center">
			<button class="btn btn-primary" onclick="merge()">Merge</button>
			<br>
			<br>
		</div>
		<div>
			<table class="table" id="merge-script-table">
				<tbody></tbody>
			</table>
		</div>
	</div>
</body>
</html>