<html>
<head>
<meta charset="UTF-8">
<title>Voice Script</title>
<link rel="stylesheet" href="voicescript.css">

<link
	href="//netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap.min.css"
	rel="stylesheet">
<script src="http://code.jquery.com/jquery-2.0.3.min.js"></script>
<script
	src="//netdna.bootstrapcdn.com/bootstrap/3.0.0/js/bootstrap.min.js"></script>
<script src="//code.jquery.com/ui/1.11.4/jquery-ui.js"></script>


<link href="bootstrap3-editable/css/bootstrap-editable.css"
	rel="stylesheet">
<script src="bootstrap3-editable/js/bootstrap-editable.js"></script>


<script src="ibmspeech.js" type="text/javascript"></script>
<script src="nwunsch.js" type="text/javascript"></script>
<script src="segment.js" type="text/javascript"></script>
<script src="script.js" type="text/javascript"></script>
<script src="visualizetext.js" type="text/javascript"></script>
<script src="merge.js" type="text/javascript"></script>

</head>

<script>
	var masterscript = null;
	var transcript = null;
	var segmenter = null;
	var match = null;
	var sortable = false;

	function loadTranscript() {
		var filename = document.getElementById("transcript_file").value;
		var request = new XMLHttpRequest();
		request.open("GET", filename, false);
		request.send(null);
		transcript = new Script();
		transcript.initFromAudio(request.responseText, null);
		reinit();
	};

	function loadMasterscript() {
		var filename = document.getElementById("masterscript_file").value;
		var request = new XMLHttpRequest();
		request.open("GET", filename, false);
		request.send(null);
		masterscript = new Script();
		masterscript.initFromText(request.responseText);
		reinit();
	};

	function reinit() {
		segmenter = null;
		match = null;
	};

	function showScripts() {
		loadTranscript();

		// Visualize correspondence per word.
		var msspan = masterscript.getSpans();
		var tspan = transcript.getSpans();
		$('#script-table tbody').empty();
		var trow = $("<tr/>");
		$('#script-table tbody:last').append(trow);
		var td = $("<td/>");
		td.addClass('col-md-6');
		td.attr('id', 'masterscript');
		trow.append(td);
		td = $("<td/>");
		td.attr('id', 'transcript');
		td.addClass('col-md-6');
		trow.append(td);
		$('#masterscript').empty().append(msspan);
		$('#transcript').empty().append(tspan);

		$('#masterscript').attr('contentEditable', true);

		if (sortable) {
			$('#script-table tbody').sortable('disable');
			$('#script-table tbody').enableSelection();
		}
		$('#btn-align').show();
		$('#btn-merge').hide();

	};

	function alignWords() {
		// Get from current script
		// Compute alignment of two texts
		var pmatch = 1;
		var pmis = -2;
		var pgap = -1;
		var aligner = new NeedlemanWunsch(masterscript, transcript, pmatch,
				pmis, pgap);
		match = aligner.align();
	};

	function alignSegments() {
		// Compute word-to-word match
		alignWords();
		segmenter = new Segmenter(masterscript, transcript, match);
		segmenter.iterateSegment(2);
		var ms_segments = segmenter.getSrc1Segments();
		var t_segments = segmenter.getSrc2Segments();
		TextSegment.matchSegments(ms_segments, t_segments, match);
		printAlignedTextSegments('#script-table', ms_segments, t_segments,
				match);

		$('#btn-align').toggle();
		$('#btn-merge').toggle();
		$('#script-table tbody').sortable('enable').disableSelection();
		sortable = true;
	};

	function mergeSegments() {
		var cell_ids = getCheckedSegs('#script-table');
		masterscript = mergeSegs2Script(cell_ids);
		showScripts();
	};

	$(window).load(function() {
		// Load sample transcript
		loadTranscript();
		loadMasterscript();
		showScripts();
	});

	$("span").on("remove", function() {
		console.log("Span was removed");
	});
	
</script>
<body>
	<div class="container">
		<div class="col-md-6">
			<h1>
				Master Script&nbsp;&nbsp; <select id="masterscript_file"
					onchange="showScripts()">
					<option value="script1.json">script1.json</option>
				</select>
			</h1>
		</div>
		<div class="col-md-6">
			<h1>
				Audio Transcript &nbsp;&nbsp; <select id="transcript_file"
					onchange="showScripts()">
					<option value="audio1.json">audio1.json</option>
					<option value="audio2.json">audio2.json</option>
					<option value="audio3.json">audio3.json</option>
					<option value="audio4.json">audio4.json</option>
				</select>
			</h1>
		</div>
		<table class="table" id="script-table">
			<tbody>
				<tr>
					<td class="col-md-6" id="masterscript"></td>
					<td class="col-md-6" id="transcript"></td>
				</tr>
			</tbody>
		</table>
		<div class="text-center">
			<button class="btn btn-primary" onclick="alignSegments()"
				id="btn-align">Align</button>
			<button class="btn btn-success" onclick="mergeSegments()"
				id="btn-merge">Merge</button>
			<br> <br>
		</div>
		<div class="col-md-12" id="merged-script"></div>
	</div>
</body>
</html>